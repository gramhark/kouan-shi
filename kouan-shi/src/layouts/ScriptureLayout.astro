---
interface Props {
  lang: string;
  title: string;
  font: string;
  fontUrl: string;
  chapterTitle: string;
  backLabel: string;
  defaultHeading: string;
  defaultMessage: string;
  storageKey: string;
  versesData: Record<number, string>;
}

const {
  lang,
  title,
  font,
  fontUrl,
  chapterTitle,
  backLabel,
  defaultHeading,
  defaultMessage,
  storageKey,
  versesData,
} = Astro.props;
---
<html lang={lang}>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
</head>
<body style={`font-family: '${font}', serif;`}>
  <div class="holy-scripture-layout">
    <nav class="verse-navigation">
      <h2>{chapterTitle}</h2>
      <ul>
        <slot />
      </ul>
    </nav>
    <main class="verse-content">
      <article id="content-article">
        <h1>{defaultHeading}</h1>
        <p>{defaultMessage}</p>
      </article>
      <!-- モバイル専用: 前/次ナビゲーション -->
      <div class="mobile-verse-nav" id="mobile-verse-nav">
        <button class="mobile-nav-btn" id="prev-verse-btn" disabled>
          {lang === 'en' ? '← Previous' : '← 前の節'}
        </button>
        <span class="mobile-nav-indicator" id="verse-indicator"></span>
        <button class="mobile-nav-btn" id="next-verse-btn" disabled>
          {lang === 'en' ? 'Next →' : '次の節 →'}
        </button>
      </div>
    </main>
    <aside class="side-panel">
      <div class="side-panel-content">
        <a href={lang === 'en' ? '/en/' : '/ja/'} class="side-link">{backLabel}</a>
        <a href="/" class="side-link">{lang === 'en' ? 'Back to Home' : '表紙へ戻る'}</a>
      </div>
    </aside>
  </div>

  <!-- モバイル専用: フローティングメニューボタン -->
  <button class="mobile-fab" id="mobile-fab" aria-label={lang === 'en' ? 'Open verse list' : '節リストを開く'}>
    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
      <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
      <line x1="8" y1="7" x2="16" y2="7"></line>
      <line x1="8" y1="11" x2="16" y2="11"></line>
    </svg>
  </button>

  <!-- モバイル専用: オーバーレイ節リスト -->
  <div class="mobile-overlay" id="mobile-overlay">
    <div class="mobile-overlay-backdrop" id="mobile-overlay-backdrop"></div>
    <div class="mobile-overlay-panel" id="mobile-overlay-panel">
      <div class="mobile-overlay-header">
        <h3>{chapterTitle}</h3>
        <button class="mobile-overlay-close" id="mobile-overlay-close" aria-label="Close">✕</button>
      </div>
      <div class="mobile-overlay-links">
        <a href={lang === 'en' ? '/en/' : '/ja/'} class="mobile-back-link">{backLabel}</a>
      </div>
      <ul class="mobile-overlay-list" id="mobile-overlay-list">
        <!-- JSで元の節リストをクローン -->
      </ul>
    </div>
  </div>

  <script type="application/json" id="verse-data" set:html={JSON.stringify(versesData)} />
  <script type="application/json" id="storage-key" set:html={JSON.stringify(storageKey)} />
  <script>
    import { marked } from 'marked';

    document.addEventListener('DOMContentLoaded', () => {
      const nav = document.querySelector('.verse-navigation');
      const article = document.getElementById('content-article');
      const links = document.querySelectorAll('.verse-navigation a');
      const versesData = JSON.parse(document.getElementById('verse-data')!.textContent!);
      const storageKey = JSON.parse(document.getElementById('storage-key')!.textContent!);

      // ソート済みの節番号リスト
      const verseNumbers = Object.keys(versesData).map(Number).sort((a, b) => a - b);
      let currentVerseIndex = -1; // 未選択状態

      // モバイルUI要素
      const fab = document.getElementById('mobile-fab');
      const overlay = document.getElementById('mobile-overlay');
      const overlayBackdrop = document.getElementById('mobile-overlay-backdrop');
      const overlayClose = document.getElementById('mobile-overlay-close');
      const overlayList = document.getElementById('mobile-overlay-list');
      const prevBtn = document.getElementById('prev-verse-btn') as HTMLButtonElement;
      const nextBtn = document.getElementById('next-verse-btn') as HTMLButtonElement;
      const verseIndicator = document.getElementById('verse-indicator');
      const mobileVerseNav = document.getElementById('mobile-verse-nav');

      // Restore scroll position on page load
      const savedScrollPos = sessionStorage.getItem(storageKey);
      if (savedScrollPos) {
        nav!.scrollTop = parseInt(savedScrollPos, 10);
      }

      function parseMarkdown(text: string): string {
        if (!text) return '';
        let cleaned = text.replace(/^\uFEFF/, '').trimStart();
        const fmMatch = cleaned.match(/^---[\t ]*[\r\n]+([\s\S]*?)[\r\n]+---[\t ]*[\r\n]*/);
        let body = fmMatch ? cleaned.slice(fmMatch[0].length) : cleaned;
        if (fmMatch && fmMatch[1].trim()) {
          body = '## ' + fmMatch[1].trim() + '\n\n' + body;
        }
        return marked.parse(body) as string;
      }

      // 節を表示する共通関数
      function showVerse(index: number) {
        if (index < 0 || index >= verseNumbers.length) return;
        currentVerseIndex = index;
        const verseNum = verseNumbers[index];
        const markdownText = versesData[verseNum];
        article!.innerHTML = parseMarkdown(markdownText);
        updateMobileNav();
        // コンテンツの先頭にスクロール
        const verseContent = document.querySelector('.verse-content');
        if (verseContent) verseContent.scrollTop = 0;
        // モバイル時はページ先頭にスクロール
        if (window.innerWidth <= 768) {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      }

      // 前/次ボタンの状態を更新
      function updateMobileNav() {
        if (!prevBtn || !nextBtn || !verseIndicator || !mobileVerseNav) return;
        if (currentVerseIndex < 0) {
          mobileVerseNav.style.display = 'none';
          return;
        }
        mobileVerseNav.style.display = '';
        prevBtn.disabled = currentVerseIndex <= 0;
        nextBtn.disabled = currentVerseIndex >= verseNumbers.length - 1;
        verseIndicator.textContent = `${currentVerseIndex + 1} / ${verseNumbers.length}`;
      }

      // --- 元のサイドバー節リストのクリック処理 ---
      links.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          sessionStorage.setItem(storageKey, String(nav!.scrollTop));
          const verseNum = (e.target as HTMLElement).dataset.verseNum;
          if (!verseNum) return;
          const index = verseNumbers.indexOf(Number(verseNum));
          showVerse(index);
        });
      });

      // --- オーバーレイに節リストを複製 ---
      if (overlayList) {
        const originalItems = nav!.querySelectorAll('li');
        originalItems.forEach((li) => {
          const clone = li.cloneNode(true) as HTMLElement;
          const cloneLink = clone.querySelector('a');
          if (cloneLink) {
            cloneLink.addEventListener('click', (e) => {
              e.preventDefault();
              const verseNum = cloneLink.dataset.verseNum;
              if (!verseNum) return;
              const index = verseNumbers.indexOf(Number(verseNum));
              showVerse(index);
              closeOverlay();
            });
          }
          overlayList.appendChild(clone);
        });
      }

      // --- フローティングボタン ---
      function openOverlay() {
        if (overlay) {
          overlay.classList.add('active');
          document.body.style.overflow = 'hidden';
        }
      }
      function closeOverlay() {
        if (overlay) {
          overlay.classList.remove('active');
          document.body.style.overflow = '';
        }
      }

      fab?.addEventListener('click', openOverlay);
      overlayBackdrop?.addEventListener('click', closeOverlay);
      overlayClose?.addEventListener('click', closeOverlay);

      // --- 前/次ボタン ---
      prevBtn?.addEventListener('click', () => {
        if (currentVerseIndex > 0) showVerse(currentVerseIndex - 1);
      });
      nextBtn?.addEventListener('click', () => {
        if (currentVerseIndex < verseNumbers.length - 1) showVerse(currentVerseIndex + 1);
      });

      // 初期状態: 前/次ボタンは非表示
      updateMobileNav();

      // モバイル時のみデフォルトメッセージを「右上の目次より～」に差し替え
      if (window.innerWidth <= 768) {
        const defaultP = article?.querySelector('p');
        if (defaultP) {
          defaultP.textContent = defaultP.textContent!
            .replace('目次より', '右上の目次より')
            .replace('from the index', 'from the index at the top right');
        }
      }
    });
  </script>
</body>
</html>

<style is:global>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap');
  @import url('https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;700&display=swap');

  body {
    margin: 0;
    padding: 0;
    background-color: #f4f1ea;
    background-image: url('/images/parchment-bg.svg');
    background-repeat: repeat;
    color: #333;
    font-weight: 400;
    opacity: 0;
    animation: fadeInPage 0.8s ease forwards;
  }

  @keyframes fadeInPage {
      from { opacity: 0; }
      to { opacity: 1; }
  }
  .holy-scripture-layout { display: flex; height: 100vh; }
  .verse-navigation { flex: 0 0 280px; border-right: 1px solid #a89b8c; padding: 2rem; overflow-y: auto; }
  .verse-navigation h2 { font-weight: 700; margin-top: 0; padding-bottom: 1rem; border-bottom: 1px solid #a89b8c; }
  .verse-navigation ul { list-style: none; padding: 0; margin: 0; }
  .verse-navigation li a { display: block; padding: 0.7rem 0; text-decoration: none; color: #5c5248; transition: all 0.2s ease; cursor: pointer; }
  .verse-navigation li a:hover { color: #333; background-color: rgba(0,0,0,0.03); transform: translateX(6px); }
  .verse-content { flex: 1 1 auto; padding: 4rem; overflow-y: auto; }
  .verse-content h1 { font-size: 2.5rem; font-weight: 700; margin-top: 0; padding-bottom: 1rem; margin-bottom: 2rem; }
  .verse-content p { font-size: 1.1rem; line-height: 2.2; }
  .verse-content h2 { font-size: 1.8rem; font-weight: 700; margin-top: 2.5rem; border-bottom: 1px solid #a89b8c; padding-bottom: 1rem; }
  .side-panel { flex: 0 0 280px; border-left: 1px solid #a89b8c; background-color: rgba(0,0,0,0.01); padding: 2rem; box-sizing: border-box; }
  .side-panel-content .side-link {
    display: block;
    text-decoration: none;
    color: #5c5248;
    padding: 0.8rem 1rem;
    margin-bottom: 1rem;
    border: 1px solid #a89b8c;
    border-radius: 5px;
    text-align: center;
    transition: all 0.2s ease;
  }
  .side-panel-content .side-link:hover {
    background-color: rgba(0,0,0,0.05);
    color: #333;
    border-color: #c4bcae;
  }

  /* ===================== */
  /* モバイル専用UI (PC非表示) */
  /* ===================== */
  .mobile-fab,
  .mobile-overlay,
  .mobile-verse-nav {
    display: none;
  }

  /* スマートフォン用の表示調整 */
  @media (max-width: 768px) {
    .holy-scripture-layout {
      flex-direction: column;
      height: auto;
    }
    /* 元の節リスト・サイドパネルを非表示 */
    .verse-navigation,
    .side-panel {
      display: none;
    }
    .verse-content {
      padding: 2rem 1.5rem;
      overflow-y: visible;
    }
    .verse-content h1 { font-size: 2rem; }
    .verse-content p { font-size: 1rem; line-height: 1.9; }
    .verse-content h2 { font-size: 1.5rem; border-bottom: 1px solid #a89b8c; padding-bottom: 0.8rem; }

    /* --- フローティングボタン --- */
    .mobile-fab {
      display: flex;
      align-items: center;
      justify-content: center;
      position: fixed;
      top: 1rem;
      right: 1rem;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: 1px solid #a89b8c;
      background-color: rgba(244, 241, 234, 0.95);
      color: #5c5248;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      cursor: pointer;
      z-index: 100;
      transition: all 0.3s ease;
    }
    .mobile-fab:active {
      transform: scale(0.92);
    }

    /* --- オーバーレイ --- */
    .mobile-overlay {
      display: block;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 200;
      pointer-events: none;
      visibility: hidden;
    }
    .mobile-overlay.active {
      pointer-events: auto;
      visibility: visible;
    }
    .mobile-overlay-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0);
      transition: background-color 0.3s ease;
    }
    .mobile-overlay.active .mobile-overlay-backdrop {
      background-color: rgba(0,0,0,0.4);
    }
    .mobile-overlay-panel {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      max-height: 70vh;
      background-color: #f4f1ea;
      border-top: 2px solid #a89b8c;
      border-radius: 16px 16px 0 0;
      transform: translateY(100%);
      transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .mobile-overlay.active .mobile-overlay-panel {
      transform: translateY(0);
    }
    .mobile-overlay-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #a89b8c;
      flex-shrink: 0;
    }
    .mobile-overlay-header h3 {
      margin: 0;
      font-weight: 700;
      font-size: 1.1rem;
      color: #333;
    }
    .mobile-overlay-close {
      background: none;
      border: none;
      font-size: 1.2rem;
      color: #5c5248;
      cursor: pointer;
      padding: 0.3rem 0.5rem;
    }
    .mobile-overlay-links {
      padding: 0.8rem 1.5rem;
      border-bottom: 1px solid #a89b8c;
      flex-shrink: 0;
    }
    .mobile-back-link {
      display: block;
      text-decoration: none;
      color: #5c5248;
      padding: 0.5rem 0;
      font-size: 0.95rem;
    }
    .mobile-overlay-list {
      list-style: none;
      padding: 0.5rem 1.5rem;
      margin: 0;
      overflow-y: auto;
      flex: 1;
      -webkit-overflow-scrolling: touch;
    }
    .mobile-overlay-list li a {
      display: block;
      padding: 0.8rem 0;
      text-decoration: none;
      color: #5c5248;
      border-bottom: 1px solid rgba(168, 155, 140, 0.3);
      transition: color 0.2s ease;
    }
    .mobile-overlay-list li:last-child a {
      border-bottom: none;
    }
    .mobile-overlay-list li a:active {
      color: #333;
      background-color: rgba(0,0,0,0.03);
    }

    /* --- 前/次ナビゲーション --- */
    .mobile-verse-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      padding: 1.5rem 0;
      margin-top: 2rem;
      border-top: 1px solid #a89b8c;
    }
    .mobile-nav-btn {
      padding: 0.8rem 1.2rem;
      border: 1px solid #a89b8c;
      border-radius: 5px;
      background-color: transparent;
      color: #5c5248;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    .mobile-nav-btn:disabled {
      opacity: 0.35;
      cursor: default;
    }
    .mobile-nav-btn:not(:disabled):active {
      background-color: rgba(0,0,0,0.05);
    }
    .mobile-nav-indicator {
      font-size: 0.9rem;
      color: #8c7d6e;
      white-space: nowrap;
    }
  }
</style>
